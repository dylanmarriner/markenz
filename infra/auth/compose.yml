name: markenz-auth

services:
  postgres_keycloak:
    image: postgres:16
    profiles: ["keycloak"]
    environment:
      POSTGRES_DB: keycloak
      POSTGRES_USER: keycloak
      POSTGRES_PASSWORD: keycloak
    volumes:
      - pg_keycloak:/var/lib/postgresql/data
    ports: ["5433:5432"]

  keycloak:
    image: quay.io/keycloak/keycloak:26.4.0
    profiles: ["keycloak"]
    command: ["start-dev","--http-port=8080","--import-realm"]
    environment:
      KC_DB: postgres
      KC_DB_URL: jdbc:postgresql://postgres_keycloak:5432/keycloak
      KC_DB_USERNAME: keycloak
      KC_DB_PASSWORD: keycloak
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    depends_on: [postgres_keycloak]
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro
    ports: ["8080:8080"]

  postgres_authentik:
    image: postgres:16
    profiles: ["authentik"]
    environment:
      POSTGRES_DB: authentik
      POSTGRES_USER: authentik
      POSTGRES_PASSWORD: authentik
    volumes:
      - pg_authentik:/var/lib/postgresql/data
    ports: ["5434:5432"]

  redis_authentik:
    image: redis:7
    profiles: ["authentik"]
    ports: ["6379:6379"]

  authentik:
    image: ghcr.io/goauthentik/server:2025.12.1
    profiles: ["authentik"]
    environment:
      AUTHENTIK_SECRET_KEY: "dev-secret-change-me"
      AUTHENTIK_POSTGRESQL__HOST: postgres_authentik
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__PASSWORD: authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
      AUTHENTIK_REDIS__HOST: redis_authentik
      AUTHENTIK_DISABLE_UPDATE_CHECK: "true"
      AUTHENTIK_DISABLE_STARTUP_ANALYTICS: "true"
    depends_on: [postgres_authentik, redis_authentik]
    ports: ["9000:9000"]
    volumes:
      - authentik_media:/media
      - authentik_templates:/templates

volumes:
  pg_keycloak:
  pg_authentik:
  authentik_media:
  authentik_templates:
